{"ast":null,"code":"import _toConsumableArray from\"/Users/samuelhancak/Documents/coronastage-stream/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _defineProperty from\"/Users/samuelhancak/Documents/coronastage-stream/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";import _objectSpread from\"/Users/samuelhancak/Documents/coronastage-stream/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _classCallCheck from\"/Users/samuelhancak/Documents/coronastage-stream/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/samuelhancak/Documents/coronastage-stream/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _inherits from\"/Users/samuelhancak/Documents/coronastage-stream/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"/Users/samuelhancak/Documents/coronastage-stream/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";import React,{Component}from\"react\";import io from\"socket.io-client\";import Video from\"./components/video\";import Videos from\"./components/videos\";var App=/*#__PURE__*/function(_Component){_inherits(App,_Component);var _super=_createSuper(App);function App(props){var _this;_classCallCheck(this,App);_this=_super.call(this,props);_this.getLocalStream=function(){// called when getUserMedia() successfully returns - see below\n// getUserMedia() returns a MediaStream object (https://developer.mozilla.org/en-US/docs/Web/API/MediaStream)\nvar success=function success(stream){window.localStream=stream;_this.setState({localStream:stream});//   var audioTracks = this.state.localStream.getAudioTracks();\n//   // if MediaStream has reference to microphone\n//   if (audioTracks[0]) {\n//     audioTracks[0].enabled = this.state.mute;\n//   }\ntoggleAudioMute=function toggleAudioMute(){var audioTracks=_this.localStream.getAudioTracks();if(audioTracks.length===0){console.log(\"No audio.\");return;}for(var i=0;i<audioTracks.length;++i){audioTracks[i].enabled=!audioTracks[i].enabled;}};_this.whoisOnline();};// called when getUserMedia() fails - see below\nvar failure=function failure(e){console.log(\"getUserMedia Error: \",e);};// https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia\n// see the above link for more constraint options\nvar constraints={audio:true,video:true,// video: {\n//   width: 1280,\n//   height: 720\n// },\n// video: {\n//   width: { min: 1280 },\n// }\noptions:{mirror:true}};// https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia\nnavigator.mediaDevices.getUserMedia(constraints).then(success).catch(failure);};_this.whoisOnline=function(){// let all peers know I am joining\n_this.sendToPeer(\"onlinePeers\",null,{local:_this.socket.id});};_this.sendToPeer=function(messageType,payload,socketID){_this.socket.emit(messageType,{socketID:socketID,payload:payload});};_this.createPeerConnection=function(socketID,callback){try{var pc=new RTCPeerConnection(_this.state.pc_config);// add pc to peerConnections object\nvar peerConnections=_objectSpread(_objectSpread({},_this.state.peerConnections),{},_defineProperty({},socketID,pc));_this.setState({peerConnections:peerConnections});pc.onicecandidate=function(e){if(e.candidate){_this.sendToPeer(\"candidate\",e.candidate,{local:_this.socket.id,remote:socketID});}};pc.oniceconnectionstatechange=function(e){};pc.ontrack=function(e){var remoteVideo={id:socketID,name:socketID,stream:e.streams[0]};_this.setState(function(prevState){// If we already have a stream in display let it stay the same, otherwise use the latest stream\nvar remoteStream=prevState.remoteStreams.length>0?{}:{remoteStream:e.streams[0]};// get currently selected video\nvar selectedVideo=prevState.remoteStreams.filter(function(stream){return stream.id===prevState.selectedVideo.id;});// if the video is still in the list, then do nothing, otherwise set to new video stream\nselectedVideo=selectedVideo.length?{}:{selectedVideo:remoteVideo};return _objectSpread(_objectSpread(_objectSpread({},selectedVideo),remoteStream),{},{remoteStreams:[].concat(_toConsumableArray(prevState.remoteStreams),[remoteVideo])});});};pc.close=function(){// alert('GONE')\n};if(_this.state.localStream)pc.addStream(_this.state.localStream);// return pc\ncallback(pc);}catch(e){console.log(\"Something went wrong! pc not created!!\",e);// return;\ncallback(null);}};_this.componentDidMount=function(){_this.socket=io.connect(\"https://20bb5aa6.ngrok.io/webrtcPeer\",{path:\"/io/web-rtc-audio\",query:{}});_this.socket.on(\"connection-success\",function(data){_this.getLocalStream();console.log(data.success);var status=data.peerCount>1?\"Total Connected Peers: \".concat(data.peerCount):\"Waiting for other peers to connect\";_this.setState({status:status});});_this.socket.on(\"peer-disconnected\",function(data){console.log(\"peer-disconnected\",data);var remoteStreams=_this.state.remoteStreams.filter(function(stream){return stream.id!==data.socketID;});_this.setState(function(prevState){// check if disconnected peer is the selected video and if there still connected peers, then select the first\nvar selectedVideo=prevState.selectedVideo.id===data.socketID&&remoteStreams.length?{selectedVideo:remoteStreams[0]}:null;return _objectSpread({// remoteStream: remoteStreams.length > 0 && remoteStreams[0].stream || null,\nremoteStreams:remoteStreams},selectedVideo);});});_this.socket.on(\"online-peer\",function(socketID){console.log(\"connected peers ...\",socketID);// create and send offer to the peer (data.socketID)\n// 1. Create new pc\n_this.createPeerConnection(socketID,function(pc){// 2. Create Offer\nif(pc)pc.createOffer(_this.state.sdpConstraints).then(function(sdp){pc.setLocalDescription(sdp);_this.sendToPeer(\"offer\",sdp,{local:_this.socket.id,remote:socketID});});});});_this.socket.on(\"offer\",function(data){_this.createPeerConnection(data.socketID,function(pc){pc.addStream(_this.state.localStream);pc.setRemoteDescription(new RTCSessionDescription(data.sdp)).then(function(){// 2. Create Answer\npc.createAnswer(_this.state.sdpConstraints).then(function(sdp){pc.setLocalDescription(sdp);_this.sendToPeer(\"answer\",sdp,{local:_this.socket.id,remote:data.socketID});});});});});_this.socket.on(\"answer\",function(data){// get remote's peerConnection\nvar pc=_this.state.peerConnections[data.socketID];console.log(data.sdp);pc.setRemoteDescription(new RTCSessionDescription(data.sdp)).then(function(){});});_this.socket.on(\"candidate\",function(data){// get remote's peerConnection\nvar pc=_this.state.peerConnections[data.socketID];if(pc)pc.addIceCandidate(new RTCIceCandidate(data.candidate));});};_this.switchVideo=function(_video){console.log(_video);_this.setState({selectedVideo:_video});};_this.state={localStream:null,// used to hold local stream object to avoid recreating the stream everytime a new offer comes\nremoteStream:null,// used to hold remote stream object that is displayed in the main screen\nmute:false,remoteStreams:[],// holds all Video Streams (all remote streams)\npeerConnections:{},// holds all Peer Connections\nselectedVideo:null,status:\"Please wait...\",pc_config:{iceServers:[{urls:\"turn:numb.viagenie.ca\",credential:\"@DGSTSj5mJukHRC\",username:\"sam2323@azet.sk\"},{urls:\"stun:stun.l.google.com:19302\"}]},sdpConstraints:{mandatory:{OfferToReceiveAudio:true,OfferToReceiveVideo:true}}};_this.socket=null;// this.candidates = []\nreturn _this;}_createClass(App,[{key:\"render\",value:function render(){//console.log(this.state.localStream);\nvar statusText=/*#__PURE__*/React.createElement(\"div\",{style:{color:\"yellow\",padding:5}},this.state.status);return/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(Video,{videoStyles:{zIndex:2,position:\"absolute\",right:0,width:200,height:200,margin:5,backgroundColor:\"black\"}// ref={this.localVideoref}\n,videoStream:this.state.localStream,autoPlay:true,muted:true}),/*#__PURE__*/React.createElement(Video,{videoStyles:{zIndex:1,position:\"fixed\",bottom:0,minWidth:\"100%\",minHeight:\"100%\",backgroundColor:\"black\"}// ref={ this.remoteVideoref }\n,videoStream:this.state.selectedVideo&&this.state.selectedVideo.stream,autoPlay:true//muted={this.state.muted}\n}),/*#__PURE__*/React.createElement(\"br\",null),/*#__PURE__*/React.createElement(\"div\",{style:{zIndex:3,position:\"absolute\",margin:10,backgroundColor:\"#cdc4ff4f\",padding:10,borderRadius:5}},statusText),/*#__PURE__*/React.createElement(\"div\",{style:{zIndex:5,position:\"absolute\",margin:10,right:10,bottom:120}},/*#__PURE__*/React.createElement(\"button\",{onMouseDown:function onMouseDown(){return toggleAudioMute();},onMouseUp:function onMouseUp(){return toggleAudioMute();}},\"Push to talk\")),/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(Videos,{switchVideo:this.switchVideo,remoteStreams:this.state.remoteStreams})),/*#__PURE__*/React.createElement(\"br\",null));}}]);return App;}(Component);export default App;","map":{"version":3,"sources":["/Users/samuelhancak/Documents/coronastage-stream/src/App.js"],"names":["React","Component","io","Video","Videos","App","props","getLocalStream","success","stream","window","localStream","setState","toggleAudioMute","audioTracks","getAudioTracks","length","console","log","i","enabled","whoisOnline","failure","e","constraints","audio","video","options","mirror","navigator","mediaDevices","getUserMedia","then","catch","sendToPeer","local","socket","id","messageType","payload","socketID","emit","createPeerConnection","callback","pc","RTCPeerConnection","state","pc_config","peerConnections","onicecandidate","candidate","remote","oniceconnectionstatechange","ontrack","remoteVideo","name","streams","prevState","remoteStream","remoteStreams","selectedVideo","filter","close","addStream","componentDidMount","connect","path","query","on","data","status","peerCount","createOffer","sdpConstraints","sdp","setLocalDescription","setRemoteDescription","RTCSessionDescription","createAnswer","addIceCandidate","RTCIceCandidate","switchVideo","_video","mute","iceServers","urls","credential","username","mandatory","OfferToReceiveAudio","OfferToReceiveVideo","statusText","color","padding","zIndex","position","right","width","height","margin","backgroundColor","bottom","minWidth","minHeight","borderRadius"],"mappings":"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","sourcesContent":["import React, { Component } from \"react\";\n\nimport io from \"socket.io-client\";\n\nimport Video from \"./components/video\";\nimport Videos from \"./components/videos\";\n\nclass App extends Component {\n  constructor(props) {\n    super(props);\n\n    this.state = {\n      localStream: null, // used to hold local stream object to avoid recreating the stream everytime a new offer comes\n      remoteStream: null, // used to hold remote stream object that is displayed in the main screen\n\n      mute: false,\n\n      remoteStreams: [], // holds all Video Streams (all remote streams)\n      peerConnections: {}, // holds all Peer Connections\n      selectedVideo: null,\n\n      status: \"Please wait...\",\n\n      pc_config: {\n        iceServers: [\n          {\n            urls: \"turn:numb.viagenie.ca\",\n            credential: \"@DGSTSj5mJukHRC\",\n            username: \"sam2323@azet.sk\",\n          },\n          {\n            urls: \"stun:stun.l.google.com:19302\",\n          },\n        ],\n      },\n\n      sdpConstraints: {\n        mandatory: {\n          OfferToReceiveAudio: true,\n          OfferToReceiveVideo: true,\n        },\n      },\n    };\n\n    this.socket = null;\n    // this.candidates = []\n  }\n\n  getLocalStream = () => {\n    // called when getUserMedia() successfully returns - see below\n    // getUserMedia() returns a MediaStream object (https://developer.mozilla.org/en-US/docs/Web/API/MediaStream)\n    const success = (stream) => {\n      window.localStream = stream;\n      this.setState({\n        localStream: stream,\n      });\n\n      //   var audioTracks = this.state.localStream.getAudioTracks();\n      //   // if MediaStream has reference to microphone\n      //   if (audioTracks[0]) {\n      //     audioTracks[0].enabled = this.state.mute;\n      //   }\n\n      toggleAudioMute = () => {\n        var audioTracks = this.localStream.getAudioTracks();\n        if (audioTracks.length === 0) {\n          console.log(\"No audio.\");\n          return;\n        }\n\n        for (var i = 0; i < audioTracks.length; ++i) {\n          audioTracks[i].enabled = !audioTracks[i].enabled;\n        }\n      };\n\n      this.whoisOnline();\n    };\n\n    // called when getUserMedia() fails - see below\n    const failure = (e) => {\n      console.log(\"getUserMedia Error: \", e);\n    };\n\n    // https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia\n    // see the above link for more constraint options\n    const constraints = {\n      audio: true,\n      video: true,\n      // video: {\n      //   width: 1280,\n      //   height: 720\n      // },\n      // video: {\n      //   width: { min: 1280 },\n      // }\n      options: {\n        mirror: true,\n      },\n    };\n\n    // https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia\n    navigator.mediaDevices\n      .getUserMedia(constraints)\n      .then(success)\n      .catch(failure);\n  };\n\n  whoisOnline = () => {\n    // let all peers know I am joining\n    this.sendToPeer(\"onlinePeers\", null, { local: this.socket.id });\n  };\n\n  sendToPeer = (messageType, payload, socketID) => {\n    this.socket.emit(messageType, {\n      socketID,\n      payload,\n    });\n  };\n\n  createPeerConnection = (socketID, callback) => {\n    try {\n      let pc = new RTCPeerConnection(this.state.pc_config);\n\n      // add pc to peerConnections object\n      const peerConnections = { ...this.state.peerConnections, [socketID]: pc };\n      this.setState({\n        peerConnections,\n      });\n\n      pc.onicecandidate = (e) => {\n        if (e.candidate) {\n          this.sendToPeer(\"candidate\", e.candidate, {\n            local: this.socket.id,\n            remote: socketID,\n          });\n        }\n      };\n\n      pc.oniceconnectionstatechange = (e) => {};\n\n      pc.ontrack = (e) => {\n        const remoteVideo = {\n          id: socketID,\n          name: socketID,\n          stream: e.streams[0],\n        };\n\n        this.setState((prevState) => {\n          // If we already have a stream in display let it stay the same, otherwise use the latest stream\n          const remoteStream =\n            prevState.remoteStreams.length > 0\n              ? {}\n              : { remoteStream: e.streams[0] };\n\n          // get currently selected video\n          let selectedVideo = prevState.remoteStreams.filter(\n            (stream) => stream.id === prevState.selectedVideo.id\n          );\n          // if the video is still in the list, then do nothing, otherwise set to new video stream\n          selectedVideo = selectedVideo.length\n            ? {}\n            : { selectedVideo: remoteVideo };\n\n          return {\n            // selectedVideo: remoteVideo,\n            ...selectedVideo,\n            // remoteStream: e.streams[0],\n            ...remoteStream,\n            remoteStreams: [...prevState.remoteStreams, remoteVideo],\n          };\n        });\n      };\n\n      pc.close = () => {\n        // alert('GONE')\n      };\n\n      if (this.state.localStream) pc.addStream(this.state.localStream);\n\n      // return pc\n      callback(pc);\n    } catch (e) {\n      console.log(\"Something went wrong! pc not created!!\", e);\n      // return;\n      callback(null);\n    }\n  };\n\n  componentDidMount = () => {\n    this.socket = io.connect(\"https://20bb5aa6.ngrok.io/webrtcPeer\", {\n      path: \"/io/web-rtc-audio\",\n      query: {},\n    });\n\n    this.socket.on(\"connection-success\", (data) => {\n      this.getLocalStream();\n\n      console.log(data.success);\n      const status =\n        data.peerCount > 1\n          ? `Total Connected Peers: ${data.peerCount}`\n          : \"Waiting for other peers to connect\";\n\n      this.setState({\n        status: status,\n      });\n    });\n\n    this.socket.on(\"peer-disconnected\", (data) => {\n      console.log(\"peer-disconnected\", data);\n\n      const remoteStreams = this.state.remoteStreams.filter(\n        (stream) => stream.id !== data.socketID\n      );\n\n      this.setState((prevState) => {\n        // check if disconnected peer is the selected video and if there still connected peers, then select the first\n        const selectedVideo =\n          prevState.selectedVideo.id === data.socketID && remoteStreams.length\n            ? { selectedVideo: remoteStreams[0] }\n            : null;\n\n        return {\n          // remoteStream: remoteStreams.length > 0 && remoteStreams[0].stream || null,\n          remoteStreams,\n          ...selectedVideo,\n        };\n      });\n    });\n\n    this.socket.on(\"online-peer\", (socketID) => {\n      console.log(\"connected peers ...\", socketID);\n\n      // create and send offer to the peer (data.socketID)\n      // 1. Create new pc\n      this.createPeerConnection(socketID, (pc) => {\n        // 2. Create Offer\n        if (pc)\n          pc.createOffer(this.state.sdpConstraints).then((sdp) => {\n            pc.setLocalDescription(sdp);\n\n            this.sendToPeer(\"offer\", sdp, {\n              local: this.socket.id,\n              remote: socketID,\n            });\n          });\n      });\n    });\n\n    this.socket.on(\"offer\", (data) => {\n      this.createPeerConnection(data.socketID, (pc) => {\n        pc.addStream(this.state.localStream);\n\n        pc.setRemoteDescription(new RTCSessionDescription(data.sdp)).then(\n          () => {\n            // 2. Create Answer\n            pc.createAnswer(this.state.sdpConstraints).then((sdp) => {\n              pc.setLocalDescription(sdp);\n\n              this.sendToPeer(\"answer\", sdp, {\n                local: this.socket.id,\n                remote: data.socketID,\n              });\n            });\n          }\n        );\n      });\n    });\n\n    this.socket.on(\"answer\", (data) => {\n      // get remote's peerConnection\n      const pc = this.state.peerConnections[data.socketID];\n      console.log(data.sdp);\n      pc.setRemoteDescription(\n        new RTCSessionDescription(data.sdp)\n      ).then(() => {});\n    });\n\n    this.socket.on(\"candidate\", (data) => {\n      // get remote's peerConnection\n      const pc = this.state.peerConnections[data.socketID];\n\n      if (pc) pc.addIceCandidate(new RTCIceCandidate(data.candidate));\n    });\n  };\n\n  switchVideo = (_video) => {\n    console.log(_video);\n    this.setState({\n      selectedVideo: _video,\n    });\n  };\n\n  render() {\n    //console.log(this.state.localStream);\n\n    const statusText = (\n      <div style={{ color: \"yellow\", padding: 5 }}>{this.state.status}</div>\n    );\n\n    return (\n      <div>\n        <Video\n          videoStyles={{\n            zIndex: 2,\n            position: \"absolute\",\n            right: 0,\n            width: 200,\n            height: 200,\n            margin: 5,\n            backgroundColor: \"black\",\n          }}\n          // ref={this.localVideoref}\n          videoStream={this.state.localStream}\n          autoPlay\n          muted\n        ></Video>\n        <Video\n          videoStyles={{\n            zIndex: 1,\n            position: \"fixed\",\n            bottom: 0,\n            minWidth: \"100%\",\n            minHeight: \"100%\",\n            backgroundColor: \"black\",\n          }}\n          // ref={ this.remoteVideoref }\n          videoStream={\n            this.state.selectedVideo && this.state.selectedVideo.stream\n          }\n          autoPlay\n          //muted={this.state.muted}\n        ></Video>\n        <br />\n        <div\n          style={{\n            zIndex: 3,\n            position: \"absolute\",\n            margin: 10,\n            backgroundColor: \"#cdc4ff4f\",\n            padding: 10,\n            borderRadius: 5,\n          }}\n        >\n          {statusText}\n        </div>\n\n        <div\n          style={{\n            zIndex: 5,\n            position: \"absolute\",\n            margin: 10,\n            right: 10,\n            bottom: 120,\n          }}\n        >\n          <button\n            onMouseDown={() => toggleAudioMute()}\n            onMouseUp={() => toggleAudioMute()}\n          >\n            Push to talk\n          </button>\n        </div>\n\n        <div>\n          <Videos\n            switchVideo={this.switchVideo}\n            remoteStreams={this.state.remoteStreams}\n          ></Videos>\n        </div>\n        <br />\n\n        {/* <div style={{zIndex: 1, position: 'fixed'}} >\n          <button onClick={this.createOffer}>Offer</button>\n          <button onClick={this.createAnswer}>Answer</button>\n          <br />\n          <textarea style={{ width: 450, height:40 }} ref={ref => { this.textref = ref }} />\n        </div> */}\n        {/* <br />\n        <button onClick={this.setRemoteDescription}>Set Remote Desc</button>\n        <button onClick={this.addCandidate}>Add Candidate</button> */}\n      </div>\n    );\n  }\n}\n\nexport default App;\n"]},"metadata":{},"sourceType":"module"}