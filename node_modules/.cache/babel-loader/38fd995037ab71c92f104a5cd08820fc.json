{"ast":null,"code":"import _toConsumableArray from\"/Users/samuelhancak/Documents/coronastage-stream/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _defineProperty from\"/Users/samuelhancak/Documents/coronastage-stream/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";import _objectSpread from\"/Users/samuelhancak/Documents/coronastage-stream/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _classCallCheck from\"/Users/samuelhancak/Documents/coronastage-stream/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/samuelhancak/Documents/coronastage-stream/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _inherits from\"/Users/samuelhancak/Documents/coronastage-stream/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"/Users/samuelhancak/Documents/coronastage-stream/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";import React,{Component}from\"react\";import io from\"socket.io-client\";import Video from\"./components/video\";import Videos from\"./components/videos\";var RTCPeerConnectionConfig={iceServers:[// {\n//   urls: \"turn:numb.viagenie.ca\",\n//   credential: \"@DGSTSj5mJukHRC\",\n//   username: \"sam2323@azet.sk\",\n// },\n{urls:\"stun:stun.l.google.com:19302\"}]};var sdpConstraints={mandatory:{OfferToReceiveAudio:true,OfferToReceiveVideo:true}};var peerConnections={};var App=/*#__PURE__*/function(_Component){_inherits(App,_Component);var _super=_createSuper(App);function App(props){var _this;_classCallCheck(this,App);_this=_super.call(this,props);_this.getLocalStream=function(){var isAdmin=_this.state.isAdmin;// called when getUserMedia() successfully returns - see below\n// getUserMedia() returns a MediaStream object (https://developer.mozilla.org/en-US/docs/Web/API/MediaStream)\nvar success=function success(stream){_this.setState({localStream:stream});var audioTracks=stream.getAudioTracks();for(var i=0;i<audioTracks.length;++i){audioTracks[i].enabled=_this.state.mute;}if(isAdmin){audioTracks[0].enabled=true;}};// called when getUserMedia() fails - see below\nvar failure=function failure(e){console.log(\"getUserMedia Error: \",e);};// https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia\n// see the above link for more constraint options\nvar constraints={audio:true,//video: true,\nvideo:isAdmin?true:{width:{max:426},height:{max:240},frameRate:{max:25}},options:{// mirror: true,\n}};// https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia\nreturn navigator.mediaDevices.getUserMedia(constraints).then(success).catch(failure);};_this.componentDidMount=function(){var isAdmin=_this.state.isAdmin;_this.getLocalStream().then(function(){// TODO: add to END\n// socket = io.connect(\"https://20bb5aa6.ngrok.io/webrtcPeer\", {\n// const socket = io.connect(\"http://localhost:8080\", {\nvar socket=io.connect(\"https://20bb5aa6.ngrok.io\",{query:{admin:isAdmin}});var sendToPeer=function sendToPeer(messageType){var payload=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;socket.emit(messageType,{socketId:socket.id,payload:payload});};var createOffer=function createOffer(pc){return pc.createOffer(sdpConstraints).then(function(offer){return pc.setLocalDescription(offer);}).then(function(){sendToPeer(\"offer\",{desc:pc.localDescription});});};var createPeerConnection=function createPeerConnection(remoteSocketId,callback){try{var pc=new RTCPeerConnection(RTCPeerConnectionConfig);// add pc to peerConnections object\npeerConnections=_objectSpread(_objectSpread({},peerConnections),{},_defineProperty({},remoteSocketId,pc));pc.onicecandidate=function(_ref){var candidate=_ref.candidate;console.log(\"onicecandidate\",{candidate:candidate});if(candidate){sendToPeer(\"candidate\",{candidate:candidate});}};pc.onnegotiationneeded=function(){console.log(\"onnegotiationneeded\");// createOffer(pc);\n};pc.oniceconnectionstatechange=function(event){console.log(\"oniceconnectionstatechange\",{event:event});console.log(pc);};pc.ontrack=function(event){console.log(\"ontrack\",{event:event});var track=event.track;if(track){_this.setState(function(_ref2){var selectedVideo=_ref2.selectedVideo,remoteStreams=_ref2.remoteStreams;var remoteStreamsCopy=_toConsumableArray(remoteStreams);// find existing stream to append audio to it or create new stream\nvar streamObjIndex=remoteStreamsCopy.findIndex(function(stream){return stream.id===remoteSocketId;});// create new stream if not in list\nif(streamObjIndex===-1){streamObjIndex=remoteStreamsCopy.push({id:remoteSocketId,name:remoteSocketId,stream:new MediaStream()})-1;}// add track to stream\nremoteStreamsCopy[streamObjIndex].stream.addTrack(track);return{selectedVideo:selectedVideo||remoteStreamsCopy[streamObjIndex],remoteStreams:remoteStreamsCopy};});}};pc.close=function(){// alert('GONE')\n};// return pc\ncallback(pc);}catch(e){console.log(\"Something went wrong! pc not created!!\",e);// return;\ncallback(null);}};socket.on(\"candidate\",function(_ref3){var socketId=_ref3.socketId,candidate=_ref3.candidate;// get remote's peerConnection\nvar pc=peerConnections[socketId];if(pc){pc.addIceCandidate(new RTCIceCandidate(candidate));}});socket.on(\"connectionSuccess\",function(_ref4){var peerCount=_ref4.peerCount;var status=isAdmin?peerCount>0?\"Total Connected Peers: \".concat(peerCount):\"Waiting for other peers to connect\":\"Connected\";_this.setState({status:status});});if(isAdmin){socket.on(\"peerJoin\",function(_ref5){var socketId=_ref5.socketId,peerCount=_ref5.peerCount;console.log(\"peerJoin\",{socketId:socketId,peerCount:peerCount});_this.setState({status:peerCount>0?\"Total Connected Peers: \".concat(peerCount):\"Waiting for other peers to connect\"});createPeerConnection(socketId,function(pc){// send video and audio to peer\nif(_this.state.localStream){_this.state.localStream.getTracks().forEach(function(track){return pc.addTrack(track);});}createOffer(pc);});});socket.on(\"answer\",function(_ref6){var socketId=_ref6.socketId,desc=_ref6.desc;console.log(\"answer\",{socketId:socketId,desc:desc});// get remote's peerConnection\nvar pc=peerConnections[socketId];if(pc){pc.setRemoteDescription(new RTCSessionDescription(desc));}});socket.on(\"peerDisconnect\",function(_ref7){var socketId=_ref7.socketId;console.log(\"peerDisconnect\",{socketId:socketId});_this.setState(function(_ref8){var remoteStreams=_ref8.remoteStreams,selectedVideo=_ref8.selectedVideo;var newStreams=remoteStreams.filter(function(stream){return stream.id!==socketId;});return{remoteStreams:newStreams,// check if disconnected peer is the selected video and if there still connected peers, then select the first\nselectedVideo:selectedVideo&&selectedVideo.id===socketId?remoteStreams[0]:selectedVideo};});});}else{socket.on(\"offer\",function(_ref9){var socketId=_ref9.socketId,desc=_ref9.desc;console.log(\"offer\",{socketId:socketId,desc:desc});createPeerConnection(socketId,function(pc){// send video and audio to peer\nif(_this.state.localStream){_this.state.localStream.getTracks().forEach(function(track){return pc.addTrack(track);});}pc.setRemoteDescription(new RTCSessionDescription(desc)).then(function(){return pc.createAnswer(sdpConstraints);}).then(function(answer){return pc.setLocalDescription(answer);}).then(function(){sendToPeer(\"answer\",{desc:pc.localDescription});});});});}});};_this.switchVideo=function(_video){_this.setState({selectedVideo:_video});};_this.state={localStream:null,// used to hold local stream object to avoid recreating the stream everytime a new offer comes\nmute:false,remoteStreams:[],// holds all Video Streams (all remote streams)\nselectedVideo:null,status:\"Please wait...\",isAdmin:window.location.pathname===\"/admin\"};return _this;}_createClass(App,[{key:\"render\",value:function render(){var _this2=this;//console.log(this.state.localStream);\nvar statusText=/*#__PURE__*/React.createElement(\"div\",{style:{color:\"yellow\",padding:5}},this.state.status);return/*#__PURE__*/React.createElement(\"div\",{style:{backgroundColor:\"black\",minHeight:\"100%\"}},this.state.isAdmin?/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(Videos,{switchVideo:this.switchVideo,remoteStreams:this.state.remoteStreams})),/*#__PURE__*/React.createElement(\"div\",{style:{zIndex:4,position:\"absolute\",margin:10,backgroundColor:\"#cdc4ff4f\",padding:10,borderRadius:5}},statusText)):/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(Video,{videoStyles:{zIndex:2,position:\"absolute\",right:0,width:200,height:200,margin:5,backgroundColor:\"black\"}// ref={this.localVideoref}\n,videoStream:this.state.localStream,autoPlay:true,muted:true}),this.state.selectedVideo?/*#__PURE__*/React.createElement(Video,{videoStyles:{zIndex:1,position:\"fixed\",bottom:0,minWidth:\"100%\",minHeight:\"100%\",backgroundColor:\"black\"}// ref={ this.remoteVideoref }\n,videoStream:this.state.selectedVideo.stream,autoPlay:true//muted={this.state.muted}\n}):null,/*#__PURE__*/React.createElement(\"div\",{style:{zIndex:4,position:\"absolute\",margin:10,backgroundColor:\"#cdc4ff4f\",padding:10,borderRadius:5}},statusText),/*#__PURE__*/React.createElement(\"div\",{style:{zIndex:5,position:\"absolute\",margin:10,right:10,bottom:120}},/*#__PURE__*/React.createElement(\"button\",{onMouseDown:function onMouseDown(){for(var i=0;i<_this2.state.localStream.getAudioTracks().length;++i){_this2.state.localStream.getAudioTracks()[i].enabled=true;}},onMouseUp:function onMouseUp(){for(var i=0;i<_this2.state.localStream.getAudioTracks().length;++i){_this2.state.localStream.getAudioTracks()[i].enabled=false;}}},\"Push to talk\"))));}}]);return App;}(Component);export default App;","map":{"version":3,"sources":["/Users/samuelhancak/Documents/coronastage-stream/src/App.jsx"],"names":["React","Component","io","Video","Videos","RTCPeerConnectionConfig","iceServers","urls","sdpConstraints","mandatory","OfferToReceiveAudio","OfferToReceiveVideo","peerConnections","App","props","getLocalStream","isAdmin","state","success","stream","setState","localStream","audioTracks","getAudioTracks","i","length","enabled","mute","failure","e","console","log","constraints","audio","video","width","max","height","frameRate","options","navigator","mediaDevices","getUserMedia","then","catch","componentDidMount","socket","connect","query","admin","sendToPeer","messageType","payload","emit","socketId","id","createOffer","pc","offer","setLocalDescription","desc","localDescription","createPeerConnection","remoteSocketId","callback","RTCPeerConnection","onicecandidate","candidate","onnegotiationneeded","oniceconnectionstatechange","event","ontrack","track","selectedVideo","remoteStreams","remoteStreamsCopy","streamObjIndex","findIndex","push","name","MediaStream","addTrack","close","on","addIceCandidate","RTCIceCandidate","peerCount","status","getTracks","forEach","setRemoteDescription","RTCSessionDescription","newStreams","filter","createAnswer","answer","switchVideo","_video","window","location","pathname","statusText","color","padding","backgroundColor","minHeight","zIndex","position","margin","borderRadius","right","bottom","minWidth"],"mappings":"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","sourcesContent":["import React, { Component } from \"react\";\n\nimport io from \"socket.io-client\";\n\nimport Video from \"./components/video\";\nimport Videos from \"./components/videos\";\n\nconst RTCPeerConnectionConfig = {\n  iceServers: [\n    // {\n    //   urls: \"turn:numb.viagenie.ca\",\n    //   credential: \"@DGSTSj5mJukHRC\",\n    //   username: \"sam2323@azet.sk\",\n    // },\n    {\n      urls: \"stun:stun.l.google.com:19302\",\n    },\n  ],\n};\n\nconst sdpConstraints = {\n  mandatory: {\n    OfferToReceiveAudio: true,\n    OfferToReceiveVideo: true,\n  },\n};\n\nlet peerConnections = {};\n\nclass App extends Component {\n  constructor(props) {\n    super(props);\n\n    this.state = {\n      localStream: null, // used to hold local stream object to avoid recreating the stream everytime a new offer comes\n\n      mute: false,\n\n      remoteStreams: [], // holds all Video Streams (all remote streams)\n      selectedVideo: null,\n\n      status: \"Please wait...\",\n\n      isAdmin: window.location.pathname === \"/admin\",\n    };\n  }\n\n  getLocalStream = () => {\n    const { isAdmin } = this.state;\n    // called when getUserMedia() successfully returns - see below\n    // getUserMedia() returns a MediaStream object (https://developer.mozilla.org/en-US/docs/Web/API/MediaStream)\n    const success = (stream) => {\n      this.setState({\n        localStream: stream,\n      });\n\n      var audioTracks = stream.getAudioTracks();\n      for (var i = 0; i < audioTracks.length; ++i) {\n        audioTracks[i].enabled = this.state.mute;\n      }\n\n      if (isAdmin) {\n        audioTracks[0].enabled = true;\n      }\n    };\n\n    // called when getUserMedia() fails - see below\n    const failure = (e) => {\n      console.log(\"getUserMedia Error: \", e);\n    };\n\n    // https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia\n    // see the above link for more constraint options\n    const constraints = {\n      audio: true,\n      //video: true,\n      video: isAdmin\n        ? true\n        : {\n            width: {\n              max: 426,\n            },\n            height: {\n              max: 240,\n            },\n            frameRate: {\n              max: 25,\n            },\n          },\n      options: {\n        // mirror: true,\n      },\n    };\n\n    // https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia\n    return navigator.mediaDevices\n      .getUserMedia(constraints)\n      .then(success)\n      .catch(failure);\n  };\n\n  componentDidMount = () => {\n    const { isAdmin } = this.state;\n\n    this.getLocalStream().then(() => {\n      // TODO: add to END\n      // socket = io.connect(\"https://20bb5aa6.ngrok.io/webrtcPeer\", {\n      // const socket = io.connect(\"http://localhost:8080\", {\n      const socket = io.connect(\"https://20bb5aa6.ngrok.io\", {\n        query: {\n          admin: isAdmin,\n        },\n      });\n\n      const sendToPeer = (messageType, payload = null) => {\n        socket.emit(messageType, {\n          socketId: socket.id,\n          payload,\n        });\n      };\n\n      const createOffer = (pc) => {\n        return pc\n          .createOffer(sdpConstraints)\n          .then((offer) => pc.setLocalDescription(offer))\n          .then(() => {\n            sendToPeer(\"offer\", {\n              desc: pc.localDescription,\n            });\n          });\n      };\n\n      const createPeerConnection = (remoteSocketId, callback) => {\n        try {\n          let pc = new RTCPeerConnection(RTCPeerConnectionConfig);\n\n          // add pc to peerConnections object\n          peerConnections = {\n            ...peerConnections,\n            [remoteSocketId]: pc,\n          };\n\n          pc.onicecandidate = ({ candidate }) => {\n            console.log(\"onicecandidate\", { candidate });\n\n            if (candidate) {\n              sendToPeer(\"candidate\", { candidate });\n            }\n          };\n\n          pc.onnegotiationneeded = () => {\n            console.log(\"onnegotiationneeded\");\n\n            // createOffer(pc);\n          };\n\n          pc.oniceconnectionstatechange = (event) => {\n            console.log(\"oniceconnectionstatechange\", { event });\n\n            console.log(pc);\n          };\n\n          pc.ontrack = (event) => {\n            console.log(\"ontrack\", { event });\n\n            const track = event.track;\n\n            if (track) {\n              this.setState(({ selectedVideo, remoteStreams }) => {\n                let remoteStreamsCopy = [...remoteStreams];\n\n                // find existing stream to append audio to it or create new stream\n                let streamObjIndex = remoteStreamsCopy.findIndex(\n                  (stream) => stream.id === remoteSocketId\n                );\n\n                // create new stream if not in list\n                if (streamObjIndex === -1) {\n                  streamObjIndex =\n                    remoteStreamsCopy.push({\n                      id: remoteSocketId,\n                      name: remoteSocketId,\n                      stream: new MediaStream(),\n                    }) - 1;\n                }\n\n                // add track to stream\n                remoteStreamsCopy[streamObjIndex].stream.addTrack(track);\n\n                return {\n                  selectedVideo:\n                    selectedVideo || remoteStreamsCopy[streamObjIndex],\n                  remoteStreams: remoteStreamsCopy,\n                };\n              });\n            }\n          };\n\n          pc.close = () => {\n            // alert('GONE')\n          };\n\n          // return pc\n          callback(pc);\n        } catch (e) {\n          console.log(\"Something went wrong! pc not created!!\", e);\n          // return;\n          callback(null);\n        }\n      };\n\n      socket.on(\"candidate\", ({ socketId, candidate }) => {\n        // get remote's peerConnection\n        const pc = peerConnections[socketId];\n\n        if (pc) {\n          pc.addIceCandidate(new RTCIceCandidate(candidate));\n        }\n      });\n\n      socket.on(\"connectionSuccess\", ({ peerCount }) => {\n        const status = isAdmin\n          ? peerCount > 0\n            ? `Total Connected Peers: ${peerCount}`\n            : \"Waiting for other peers to connect\"\n          : \"Connected\";\n\n        this.setState({\n          status,\n        });\n      });\n\n      if (isAdmin) {\n        socket.on(\"peerJoin\", ({ socketId, peerCount }) => {\n          console.log(\"peerJoin\", { socketId, peerCount });\n\n          this.setState({\n            status:\n              peerCount > 0\n                ? `Total Connected Peers: ${peerCount}`\n                : \"Waiting for other peers to connect\",\n          });\n\n          createPeerConnection(socketId, (pc) => {\n            // send video and audio to peer\n            if (this.state.localStream) {\n              this.state.localStream\n                .getTracks()\n                .forEach((track) => pc.addTrack(track));\n            }\n\n            createOffer(pc);\n          });\n        });\n\n        socket.on(\"answer\", ({ socketId, desc }) => {\n          console.log(\"answer\", { socketId, desc });\n\n          // get remote's peerConnection\n          const pc = peerConnections[socketId];\n\n          if (pc) {\n            pc.setRemoteDescription(new RTCSessionDescription(desc));\n          }\n        });\n\n        socket.on(\"peerDisconnect\", ({ socketId }) => {\n          console.log(\"peerDisconnect\", { socketId });\n\n          this.setState(({ remoteStreams, selectedVideo }) => {\n            const newStreams = remoteStreams.filter(\n              (stream) => stream.id !== socketId\n            );\n\n            return {\n              remoteStreams: newStreams,\n              // check if disconnected peer is the selected video and if there still connected peers, then select the first\n              selectedVideo:\n                selectedVideo && selectedVideo.id === socketId\n                  ? remoteStreams[0]\n                  : selectedVideo,\n            };\n          });\n        });\n      } else {\n        socket.on(\"offer\", ({ socketId, desc }) => {\n          console.log(\"offer\", { socketId, desc });\n\n          createPeerConnection(socketId, (pc) => {\n            // send video and audio to peer\n            if (this.state.localStream) {\n              this.state.localStream\n                .getTracks()\n                .forEach((track) => pc.addTrack(track));\n            }\n\n            pc.setRemoteDescription(new RTCSessionDescription(desc))\n              .then(() => pc.createAnswer(sdpConstraints))\n              .then((answer) => pc.setLocalDescription(answer))\n              .then(() => {\n                sendToPeer(\"answer\", {\n                  desc: pc.localDescription,\n                });\n              });\n          });\n        });\n      }\n    });\n  };\n\n  switchVideo = (_video) => {\n    this.setState({\n      selectedVideo: _video,\n    });\n  };\n\n  render() {\n    //console.log(this.state.localStream);\n\n    const statusText = (\n      <div style={{ color: \"yellow\", padding: 5 }}>{this.state.status}</div>\n    );\n\n    return (\n      <div style={{ backgroundColor: \"black\", minHeight: \"100%\" }}>\n        {this.state.isAdmin ? (\n          <>\n            <div>\n              <Videos\n                switchVideo={this.switchVideo}\n                remoteStreams={this.state.remoteStreams}\n              ></Videos>\n            </div>\n            <div\n              style={{\n                zIndex: 4,\n                position: \"absolute\",\n                margin: 10,\n                backgroundColor: \"#cdc4ff4f\",\n                padding: 10,\n                borderRadius: 5,\n              }}\n            >\n              {statusText}\n            </div>\n          </>\n        ) : (\n          <>\n            <Video\n              videoStyles={{\n                zIndex: 2,\n                position: \"absolute\",\n                right: 0,\n                width: 200,\n                height: 200,\n                margin: 5,\n                backgroundColor: \"black\",\n              }}\n              // ref={this.localVideoref}\n              videoStream={this.state.localStream}\n              autoPlay\n              muted\n            ></Video>\n\n            {this.state.selectedVideo ? (\n              <Video\n                videoStyles={{\n                  zIndex: 1,\n                  position: \"fixed\",\n                  bottom: 0,\n                  minWidth: \"100%\",\n                  minHeight: \"100%\",\n                  backgroundColor: \"black\",\n                }}\n                // ref={ this.remoteVideoref }\n                videoStream={this.state.selectedVideo.stream}\n                autoPlay\n                //muted={this.state.muted}\n              ></Video>\n            ) : null}\n\n            <div\n              style={{\n                zIndex: 4,\n                position: \"absolute\",\n                margin: 10,\n                backgroundColor: \"#cdc4ff4f\",\n                padding: 10,\n                borderRadius: 5,\n              }}\n            >\n              {statusText}\n            </div>\n\n            <div\n              style={{\n                zIndex: 5,\n                position: \"absolute\",\n                margin: 10,\n                right: 10,\n                bottom: 120,\n              }}\n            >\n              <button\n                onMouseDown={() => {\n                  for (\n                    var i = 0;\n                    i < this.state.localStream.getAudioTracks().length;\n                    ++i\n                  ) {\n                    this.state.localStream.getAudioTracks()[i].enabled = true;\n                  }\n                }}\n                onMouseUp={() => {\n                  for (\n                    var i = 0;\n                    i < this.state.localStream.getAudioTracks().length;\n                    ++i\n                  ) {\n                    this.state.localStream.getAudioTracks()[i].enabled = false;\n                  }\n                }}\n              >\n                Push to talk\n              </button>\n            </div>\n          </>\n        )}\n      </div>\n    );\n  }\n}\n\nexport default App;\n"]},"metadata":{},"sourceType":"module"}